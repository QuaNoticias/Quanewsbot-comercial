<!-- templates/client_dashboard.html - VERSÃO 3.2 COM CONFIGS DE REMIX -->
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel do Cliente - NewsBot</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <style>
        body { background-color: #f0f2f5; }
        .navbar-brand img { height: 40px; }
        .card { border: none; border-radius: 0.75rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05); }
        .nav-tabs .nav-link { color: #6c757d; }
        .nav-tabs .nav-link.active { color: #000; font-weight: bold; }
        .summary-card { text-align: center; padding: 1.5rem; }
        .summary-card .icon { font-size: 2.5rem; color: #0d6efd; }
        .summary-card .value { font-size: 2rem; font-weight: bold; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container">
            <a class="navbar-brand" href="#"><img src="{{ url_for('static', filename='newsbot-logo.png') }}" alt="NewsBot Logo"></a>
            <div class="d-flex">
                <span class="navbar-text me-3">Bem-vindo, <strong>{{ session.get('username') }}</strong>!</span>
                <a href="{{ url_for('logout') }}" class="btn btn-outline-danger">Sair</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Alertas Flash -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- Abas de Navegação -->
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation"><button class="nav-link active" id="results-tab" data-bs-toggle="tab" data-bs-target="#results" type="button"><i class="bi bi-graph-up-arrow me-1"></i>Resultados</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" id="performance-tab" data-bs-toggle="tab" data-bs-target="#performance" type="button"><i class="bi bi-activity me-1"></i>Desempenho</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" id="config-tab" data-bs-toggle="tab" data-bs-target="#config" type="button"><i class="bi bi-gear-fill me-1"></i>Configurações</button></li>
        </ul>

        <!-- Conteúdo das Abas -->
        <div class="tab-content p-3" id="myTabContent">
            <!-- Aba de Resultados -->
            <div class="tab-pane fade show active" id="results" role="tabpanel">
                <div class="row">
                    <div class="col-md-6 mb-4"><div class="card summary-card"><i class="bi bi-newspaper icon"></i><div id="summary-news" class="value">0</div><div class="text-muted">Notícias Analisadas</div></div></div>
                    <div class="col-md-6 mb-4"><div class="card summary-card"><i class="bi bi-instagram icon"></i><div id="summary-posts" class="value">0</div><div class="text-muted">Posts Publicados</div></div></div>
                </div>
                <div class="card"><div class="card-header">Crescimento de Seguidores</div><div class="card-body"><div id="growth-chart"></div></div></div>
            </div>

            <!-- Aba de Desempenho -->
            <div class="tab-pane fade" id="performance" role="tabpanel">
                <div class="card"><div class="card-header">Log de Atividades do Agente</div><div class="card-body"><div class="table-responsive"><table class="table table-sm table-striped"><thead><tr><th>Horário</th><th>Tipo</th><th>Detalhes</th></tr></thead><tbody id="performance-log-table"></tbody></table></div></div></div>
            </div>

            <!-- Aba de Configurações -->
            <div class="tab-pane fade" id="config" role="tabpanel">
                <div class="card"><div class="card-header">Credenciais e Configurações</div><div class="card-body">
                    <form action="{{ url_for('save_config') }}" method="POST">
                        <div class="mb-3"><label for="wordpress_url" class="form-label">URL do Site WordPress</label><input type="url" class="form-control" id="wordpress_url" name="wordpress_url" required></div>
                        <div class="mb-3"><label for="instagram_user" class="form-label">Usuário do Instagram</label><input type="text" class="form-control" id="instagram_user" name="instagram_user" required></div>
                        <div class="mb-3"><label for="instagram_pass" class="form-label">Senha do Instagram</label><input type="password" class="form-control" id="instagram_pass" name="instagram_pass" placeholder="Deixe em branco para não alterar"></div>
                        <div class="mb-3"><label for="report_email" class="form-label">Email para Relatório</label><input type="email" class="form-control" id="report_email" name="report_email"><div class="form-text">Deixe em branco se não desejar receber relatórios diários.</div></div>
                        
                        <!-- NOVAS CONFIGURAÇÕES DE REMIX -->
                        <hr>
                        <div class="mb-3">
                            <h5><i class="bi bi-robot me-2"></i>Tarefa de Remix (BETA)</h5>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" role="switch" id="enable_remix" name="enable_remix">
                                <label class="form-check-label" for="enable_remix">Ativar publicação automática de Remix com tendências</label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="remix_keywords" class="form-label">Palavras-chave do seu Nicho</label>
                            <input type="text" class="form-control" id="remix_keywords" name="remix_keywords" placeholder="Ex: notícias, política, economia, Cuiabá">
                            <div class="form-text">Ajude o agente a encontrar tendências relevantes para você. Separe por vírgulas.</div>
                        </div>

                        <button type="submit" class="btn btn-primary mt-3">Salvar Configurações</button>
                    </form>
                </div></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    document.addEventListener("DOMContentLoaded", () => {
        function formatLocalDate(utcStr) { if (!utcStr) return ''; const date = new Date(utcStr + 'Z'); return date.toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }); }

        fetch('/api/client_panel_data')
            .then(response => response.json())
            .then(data => {
                // Aba de Resultados
                document.getElementById('summary-news').innerText = data.results.summary_cards.news_analyzed;
                document.getElementById('summary-posts').innerText = data.results.summary_cards.posts_published;
                const growthOptions = { series: [{ name: 'Seguidores', data: data.results.growth_chart.data }], chart: { type: 'area', height: 350, zoom: { enabled: false } }, dataLabels: { enabled: false }, stroke: { curve: 'smooth' }, xaxis: { type: 'datetime', categories: data.results.growth_chart.labels }, tooltip: { x: { format: 'dd/MM/yy' } }, };
                new ApexCharts(document.querySelector("#growth-chart"), growthOptions).render();

                // Aba de Desempenho
                const logTableBody = document.getElementById('performance-log-table');
                let logHtml = '';
                if (data.performance.logs.length > 0) { data.performance.logs.forEach(log => { logHtml += <tr><td>${formatLocalDate(log.timestamp)}</td><td>${log.event_type}</td><td>${log.message}</td></tr>; }); } else { logHtml = '<tr><td colspan="3" class="text-center">Nenhuma atividade registrada.</td></tr>'; }
                logTableBody.innerHTML = logHtml;

                // Aba de Configurações
                document.getElementById('wordpress_url').value = data.config.wordpress_url || '';
                document.getElementById('instagram_user').value = data.config.instagram_user || '';
                document.getElementById('report_email').value = data.config.report_email || '';
                // Preenche os novos campos de Remix
                document.getElementById('enable_remix').checked = data.config.enable_remix_task === 1;
                document.getElementById('remix_keywords').value = data.config.remix_niche_keywords || '';
            })
            .catch(error => console.error('Falha ao carregar dados do painel:', error));
    });
    </script>
</body>
</html>